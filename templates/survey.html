{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìˆ¨íŠ¸ì—¬ - ë‚˜ë§Œì˜ ì—¬í–‰ ìŠ¤íƒ€ì¼ ì°¾ê¸°</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif; 
      background-color: #E6F5E0; 
      margin: 0; 
      padding: 20px; 
      color: #333; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      min-height: 100vh; 
      box-sizing: border-box; 
    }

    .container {
      max-width: 900px; 
      width: 100%; 
      background: #fff; 
      padding: 40px 50px; 
      border-radius: 16px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
      text-align: center; 
    }

    h1 {
      color: #2E7D32; 
      margin-bottom: 25px; 
      font-size: 2.4em; 
    }

    .slide {
      display: none; 
    }

    .slide.active {
      display: block; 
      animation: fadeInSlide 0.6s ease-in-out; 
    }

    @keyframes fadeInSlide {
      from { opacity: 0; transform: translateY(20px);  }
      to { opacity: 1; transform: translateY(0);  }
    }

    .slide h2 {
      color: #1A237E; 
      margin-bottom: 30px; 
      font-size: 1.8em; 
      border-bottom: 2px solid #B2DFDB; 
      padding-bottom: 12px; 
    }

    .option-grid {
      display: grid; 
      grid-template-columns: repeat(4, 1fr); 
      gap: 20px; 
      margin-top: 25px; 
      margin-bottom: 35px; 
    }

    .card {
      background: #F8F9FA; 
      border: 1px solid #DEE2E6; 
      border-radius: 12px; 
      padding: 20px; 
      text-align: center; 
      cursor: pointer; 
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: flex-start; 
    }

    .card:hover {
      transform: translateY(-5px); 
      box-shadow: 0 6px 15px rgba(0,0,0,0.1); 
    }

    .card.selected {
        border-color: #2E7D32; 
        box-shadow: 0 0 10px rgba(46, 125, 50, 0.5); 
    }

    .card img {
      width: 100%; 
      max-width: 170px; 
      height: 130px; 
      object-fit: cover; 
      border-radius: 8px; 
      margin-bottom: 12px; 
      border: 2px solid #B2DFDB; 
    }

    .card label {
      font-size: 1em; 
      color: #333; 
      display: flex; 
      align-items: center; 
      cursor: pointer; 
      line-height: 1.4; 
      margin-top: 0; 
      text-align: left; 
      width: 100%; 
    }

    .card input[type="checkbox"] {
      margin-right: 8px; 
      accent-color: #2E7D32; 
      min-width: 16px; 
      height: 16px; 
    }

    .navigation {
      margin-top: 35px; 
      display: flex; 
      justify-content: space-between; 
    }

    .navigation button, .submit-button {
      background-color: #2E7D32; 
      color: white; 
      border: none; 
      padding: 14px 30px; 
      font-size: 1.1em; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: background-color 0.3s ease; 
      min-width: 120px; 
    }

    .navigation button:hover, .submit-button:hover {
      background-color: #1B5E20; 
    }

    .progress-bar-container {
        width: 100%; 
        background-color: #ddd; 
        border-radius: 5px; 
        margin-bottom: 40px; 
    }

    .progress-bar {
        width: 0%; 
        height: 12px; 
        background-color: #4CAF50; 
        border-radius: 5px; 
        transition: width 0.5s ease-in-out; 
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>

  <div class="container">
    <h1>ìˆ¨ íŠ¸ì´ëŠ” ë‚˜ë§Œì˜ ì—¬í–‰ ìŠ¤íƒ€ì¼ ì°¾ê¸° ğŸŒ¿</h1>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <form id="surveyForm">
      {% csrf_token %} <div class="slide active">
        <h2>Q1. ëˆ„êµ¬ì™€ í•¨ê»˜í•˜ëŠ” ì—¬í–‰ì„ ê°€ì¥ ì„ í˜¸í•˜ì‹œë‚˜ìš”? </h2>
        <div class="option-grid">
          <div class="card">
            <img src="{% static 'backpacking-4400872.jpg' %}" alt="í˜¼ì ì—¬í–‰">
            <label><input type="checkbox" name="q1_companion" value="1"> í˜¼ì</label>
          </div>
          <div class="card">
            <img src="{% static 'family-6398107.jpg' %}" alt="ê°€ì¡± ì—¬í–‰">
            <label><input type="checkbox" name="q1_companion" value="2"> ê°€ì¡±</label> 
          </div>
          <div class="card">
            <img src="{% static 'couple-6796433_1920.jpg' %}" alt="ì¹œêµ¬/ì—°ì¸ ì—¬í–‰">
            <label><input type="checkbox" name="q1_companion" value="3"> ì¹œêµ¬/ì—°ì¸</label>
          </div>
          <div class="card">
            <img src="{% static 'ekscp.jpg' %}" alt="ë™ë£Œ/ë‹¨ì²´ ì—¬í–‰">
            <label><input type="checkbox" name="q1_companion" value="4"> ë™ë£Œ/ë‹¨ì²´</label> 
          </div>
        </div>
        <div class="navigation">
          <button type="button" style="visibility: hidden;">â—€ ì´ì „</button>
          <button type="button" onclick="nextSlide()">â–¶ ë‹¤ìŒ</button>
        </div>
      </div>

      <div class="slide">
        <h2>Q2. ê´€ê´‘ì§€ì—ì„œ ì–´ë–¤ í™œë™ì„ ê°€ì¥ ì¤‘ìš”í•˜ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”? </h2>
        <p style="font-size:0.9em; color:#555;">(ìˆ¨ íŠ¸ì´ëŠ” ìì—° ì†ì—ì„œ ì¦ê¸°ëŠ” í™œë™)</p>
        <div class="option-grid">
          <div class="card">
            <img src="{% static 'road-1072821.jpg' %}" alt="ìì—° ê²½ê´€ ê°ìƒê³¼ ì‚°ì±…">
            <label><input type="checkbox" name="q2_activity" value="1"> ë“œë„“ì€ ìì—° ê²½ê´€ ê°ìƒê³¼ ì—¬ìœ ë¡œìš´ ì‚°ì±…</label>
          </div>
          <div class="card">
            <img src="{% static 'gyeongbok-palace-7853873.jpg' %}" alt="ì—­ì‚¬ ìœ ì ì§€, ë¬¸í™” ì‹œì„¤ íƒë°©">
            <label><input type="checkbox" name="q2_activity" value="2"> ì˜¤ë˜ëœ ì—­ì‚¬ ìœ ì ì§€ë‚˜ í¥ë¯¸ë¡œìš´ ë¬¸í™” ì‹œì„¤ íƒë°©</label> 
          </div>
          <div class="card">
            <img src="{% static 'paraglider-701440.jpg' %}" alt="íŠ¹ë³„í•œ ì²´í—˜ í™œë™ ì°¸ì—¬">
             <label><input type="checkbox" name="q2_activity" value="3"> ê·¸ ì§€ì—­ë§Œì˜ íŠ¹ë³„í•œ ì²´í—˜ í™œë™ ì°¸ì—¬</label> 
          </div>
          <div class="card">
            <img src="{% static 'girl-4181395.jpg' %}" alt="ê¸°ë…í’ˆ êµ¬ê²½, í˜„ì§€ ë¶„ìœ„ê¸°">
            <label><input type="checkbox" name="q2_activity" value="4"> ì˜ˆìœ ê¸°ë…í’ˆì„ êµ¬ê²½í•˜ê³  í˜„ì§€ ë¶„ìœ„ê¸° ëŠë¼ê¸°</label>
          </div>
        </div>
        <div class="navigation"> 
          <button type="button" onclick="prevSlide()">â—€ ì´ì „</button>
          <button type="button" onclick="nextSlide()">â–¶ ë‹¤ìŒ</button>
        </div>
      </div>

      <div class="slide">
        <h2>Q3. ì—¬í–‰ ì¤‘ ê°€ì¥ í¸ì•ˆí•¨ì„ ëŠë¼ëŠ” ìì—° í’ê²½ì€ ì–´ë””ì¸ê°€ìš”? </h2>
        <p style="font-size:0.9em; color:#555;">(ìˆ¨ ì‰¬ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ ë¨¸ë¬´ë¥´ëŠ” ê³³)</p>
        <div class="option-grid">
          <div class="card">
            <img src="{% static 'trees-9424194.jpg' %}" alt="ê³ ìš”í•œ ìˆ², ì˜ ê°€ê¿”ì§„ ì •ì›">
            <label><input type="checkbox" name="q3_scenery" value="1"> ê³ ìš”í•œ ìˆ²ì´ë‚˜ ì˜ ê°€ê¿”ì§„ ì •ì›</label>
          </div>
           <div class="card"> 
            <img src="{% static 'mt-seolark-4847249.jpg' %}" alt="ì‚° ì •ìƒ, ì–¸ë• ìœ„ ì „ë§ ê³µê°„">
            <label><input type="checkbox" name="q3_scenery" value="2"> ì‚° ì •ìƒì´ë‚˜ ì–¸ë• ìœ„ íƒ íŠ¸ì¸ ì „ë§ ê³µê°„</label>
          </div>
          <div class="card">
            <img src="{% static 'lake-6641880.jpg' %}" alt="ì”ì”í•œ í˜¸ìˆ˜, ì‹œì›í•œ ê³„ê³¡ê°€">
            <label><input type="checkbox" name="q3_scenery" value="3"> ì”ì”í•œ í˜¸ìˆ˜ë‚˜ ì‹œì›í•œ ê³„ê³¡ê°€</label> 
          </div>
          <div class="card">
            <img src="{% static 'meadow-2421732.jpg' %}" alt="í’ê²½ ì¢‹ì€ í•´ì•ˆê¸¸, í•œì í•œ ì˜¤ì†”ê¸¸">
            <label><input type="checkbox" name="q3_scenery" value="4"> í’ê²½ ì¢‹ì€ í•´ì•ˆê¸¸ì´ë‚˜ í•œì í•œ ì˜¤ì†”ê¸¸</label>
          </div>
        </div>
        <div class="navigation">
          <button type="button" onclick="prevSlide()">â—€ ì´ì „</button> 
          <button type="button" onclick="nextSlide()">â–¶ ë‹¤ìŒ</button>
        </div>
      </div>

      <div class="slide">
        <h2>Q4. ì—¬í–‰ì§€ì—ì„œ ìƒˆë¡œìš´ ìŒì‹ì„ ì‹œë„í•˜ëŠ” ê²ƒì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”? </h2>
        <p style="font-size:0.9em; color:#555;">(ì—¬í–‰ì˜ ë˜ ë‹¤ë¥¸ ì¦ê±°ì›€!)</p>
        <div class="option-grid">
          <div class="card">
            <label><input type="radio" name="q4_food" value="1"> ë§¤ìš° ì ê·¹ì ! í˜„ì§€ ìŒì‹ì€ ì—¬í–‰ì˜ í° ì¦ê±°ì›€ì´ë‹¤.</label> 
          </div>
          <div class="card">
            <label><input type="radio" name="q4_food" value="2"> ê°€ë” ë„ì „! ë§›ìˆì–´ ë³´ì´ê±°ë‚˜ ì¶”ì²œ ë°›ìœ¼ë©´ ì‹œë„í•œë‹¤.</label> 
          </div>
          <div class="card">
            <label><input type="radio" name="q4_food" value="3"> ì¡°ê¸ˆ ì†Œê·¹ì . ìµìˆ™í•˜ê±°ë‚˜ ì‹¤íŒ¨ í™•ë¥  ì ì€ ìŒì‹ì„ ì„ í˜¸í•œë‹¤.</label> 
          </div>
          <div class="card">
            <label><input type="radio" name="q4_food" value="4"> ì „í˜€ ì•ˆ í•¨. ìŒì‹ë³´ë‹¤ëŠ” ë‹¤ë¥¸ ê²½í—˜ì— ì§‘ì¤‘í•œë‹¤.</label> 
          </div>
        </div>
        <div class="navigation">
          <button type="button" onclick="prevSlide()">â—€ ì´ì „</button>
          <button type="submit" class="submit-button">ì„¤ë¬¸ ê²°ê³¼ ì œì¶œ</button>
        </div>
      </div>

    </form>

    </div>

<script>
  // Django í…œí”Œë¦¿ íƒœê·¸ë¥¼ ì‚¬ìš©í•´ ë©”ì¸ í˜ì´ì§€ì˜ URLì„ JavaScript ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
  const mainPageUrl = "{% url 'core:main_page' %}";
  
  // Django ë·°ì—ì„œ ì „ë‹¬ë°›ì€ ì‚¬ìš©ì ì´ë¦„ì„ JavaScript ë³€ìˆ˜ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
  const currentUsername = '{{ username|escapejs }}';

  let current = 0;
  const slides = document.querySelectorAll(".slide");
  const form = document.getElementById('surveyForm');
  const progressBar = document.getElementById("progressBar");
  const totalSlides = slides.length;

  // í˜ì´ì§€ ë¡œë“œ ì‹œ, ì´ë¯¸ ì™„ë£Œí•œ ì‚¬ìš©ìì¸ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
  document.addEventListener('DOMContentLoaded', () => {
    if (!currentUsername) {
      alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      window.location.href = mainPageUrl;
      return;
    }
    const surveyStatus = localStorage.getItem(`surveyStatus_${currentUsername}`);
    if (surveyStatus === 'completed') {
      alert("ì´ë¯¸ ì„¤ë¬¸ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      window.location.href = mainPageUrl;
    }
  });

  // ì¹´ë“œ ì„ íƒ, í”„ë¡œê·¸ë ˆìŠ¤ë°”, ìŠ¬ë¼ì´ë“œ ì´ë™ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ê³¼ ë™ì¼)
  document.querySelectorAll('.card').forEach(card => {
    card.addEventListener('click', function(event) {
      if (event.target.closest('label') === null) {
        const checkboxOrRadio = this.querySelector('input');
        if (checkboxOrRadio) {
          checkboxOrRadio.checked = !checkboxOrRadio.checked;
          const changeEvent = new Event('change', { bubbles: true });
          checkboxOrRadio.dispatchEvent(changeEvent);
        }
      }
    });
  });

  document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(input => {
    input.addEventListener('change', function() {
      if (this.type === 'radio') {
        document.querySelectorAll(`input[name="${this.name}"]`).forEach(radio => {
          radio.closest('.card').classList.remove('selected');
        });
      }
      this.closest('.card').classList.toggle('selected', this.checked);
    });
  });

  function updateProgressBar() {
    const progressPercentage = ((current + 1) / totalSlides) * 100;
    progressBar.style.width = progressPercentage + "%";
  }

  function showSlide(index) {
    slides.forEach((slide, i) => {
      slide.classList.toggle("active", i === index);
    });
    updateProgressBar();
  }

  function nextSlide() {
    const currentInputs = slides[current].querySelectorAll('input:checked');
    if (currentInputs.length === 0) {
      alert("í•˜ë‚˜ ì´ìƒ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }
    if (current < slides.length - 1) {
      current++;
      showSlide(current);
    }
  }

  function prevSlide() {
    if (current > 0) {
      current--;
      showSlide(current);
    }
  }
  
  showSlide(current);

  // â–¼â–¼â–¼ [ìˆ˜ì •ëœ ë¶€ë¶„] í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (API í˜¸ì¶œ ê¸°ëŠ¥ ì¶”ê°€) â–¼â–¼â–¼
  form.addEventListener('submit', function(event) {
    event.preventDefault(); // í¼ì˜ ê¸°ë³¸ ì œì¶œ ë™ì‘ì„ ë§‰ìŠµë‹ˆë‹¤.

    // ë§ˆì§€ë§‰ ì§ˆë¬¸ì— ëŒ€í•œ ìœ íš¨ì„± ê²€ì‚¬
    const lastInputs = slides[current].querySelectorAll('input:checked');
    if (lastInputs.length === 0) {
        alert("í•˜ë‚˜ ì´ìƒ í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
    }

    // ì„¤ë¬¸ ê²°ê³¼ ìˆ˜ì§‘ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
    function getSelectedValuesAsArray(name) {
      const values = [];
      const checkedInputs = form.querySelectorAll(`input[name="${name}"]:checked`);
      checkedInputs.forEach(input => {
        values.push(input.value);
      });
      return values;
    }

    const surveyResults = {
      companion: getSelectedValuesAsArray('q1_companion'),
      activity: getSelectedValuesAsArray('q2_activity'),
      scenery: getSelectedValuesAsArray('q3_scenery'),
      food: form.querySelector('input[name="q4_food"]:checked')?.value || 'N/A'
    };
    
    // CSRF í† í° ê°’ ê°€ì ¸ì˜¤ê¸°
    const csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

    // --- ë°±ì—”ë“œ API í˜¸ì¶œ ---
    // ì‹¤ì œ API ì—”ë“œí¬ì¸íŠ¸ URLë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤. 
    // ì˜ˆ: {% url 'survey_api:submit' %} ë˜ëŠ” '/api/survey/submit/'
    const apiUrl = '/api/submit-survey/'; 

    fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken // í—¤ë”ì— CSRF í† í° ì¶”ê°€
      },
      body: JSON.stringify(surveyResults) // JavaScript ê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
    })
    .then(response => {
      // ì„œë²„ ì‘ë‹µì´ ì„±ê³µì ì¸ì§€ í™•ì¸ (e.g., 200 OK)
      if (!response.ok) {
        // ì„œë²„ì—ì„œ ì—ëŸ¬ ì‘ë‹µì„ ë³´ëƒˆì„ ê²½ìš°
        throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.statusText}`);
      }
      return response.json(); // ì‘ë‹µ ë³¸ë¬¸ì„ JSONìœ¼ë¡œ íŒŒì‹±
    })
    .then(data => {
      // API í˜¸ì¶œ ì„±ê³µ ì‹œ ì²˜ë¦¬
      console.log('ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤:', data);

      // [ì¤‘ìš”] ì œì¶œ ì„±ê³µ ì‹œì—ë§Œ 'ì™„ë£Œ' ìƒíƒœë¥¼ localStorageì— ì €ì¥
      if (currentUsername) {
        localStorage.setItem(`surveyStatus_${currentUsername}`, 'completed');
      }

      // ì•Œë¦¼ì„ ë„ìš°ê³  ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      alert("ì„¤ë¬¸ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!");
      window.location.href = mainPageUrl;
    })
    .catch(error => {
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
      console.error('ì„¤ë¬¸ ì œì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      alert("ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì„¤ë¬¸ ê²°ê³¼ë¥¼ ì œì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    });
  });
  // â–²â–²â–² [ìˆ˜ì •ëœ ë¶€ë¶„] â–²â–²â–²
</script>