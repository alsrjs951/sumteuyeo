<!DOCTYPE html>
<html>
<head>
    <title>주변 관광지 정보 불러오기</title>
    <style>
        /* 간단한 상태 메시지 스타일 */
        #statusMessage {
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #eee;
            background-color: #f9f9f9;
            text-align: center;
            font-family: sans-serif;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>주변 관광지 정보 로딩</h1>

    {% csrf_token %}

    <div id="statusMessage">페이지 로드 완료. 위치 정보를 가져옵니다...</div>

    <script>
        // --- DOM 요소 ---
        const statusMessageDiv = document.getElementById('statusMessage');
        // CSRF 토큰 값 가져오기
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // --- 페이지 로드 완료 시 실행 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. 사용자 위치 정보 얻기 시작
            if (!navigator.geolocation) {
                updateStatus('브라우저가 위치 정보를 지원하지 않습니다.', true);
                return;
            }

            updateStatus('위치 정보 권한을 요청합니다...');
            // getCurrentPosition(성공 콜백, 실패 콜백, 옵션)
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // 위치 정보 얻기 성공
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    updateStatus(`위치 확인 완료 (위도: ${latitude.toFixed(5)}, 경도: ${longitude.toFixed(5)}). 주변 관광지 정보를 요청합니다...`);

                    // 2. 백엔드 API 호출 함수 실행 (위치 정보 전달)
                    fetchNearbyPlacesData(latitude, longitude);
                },
                (error) => {
                    // 위치 정보 얻기 실패
                    handleLocationError(error);
                },
                {
                    enableHighAccuracy: false,
                    timeout: 10000, // 최대 대기 시간 (10초)
                    maximumAge: 0
                }
            );
        });

        // --- 백엔드 API 호출 함수 (주변 관광지 정보) ---
        async function fetchNearbyPlacesData(lat, lon) {
            // urls.py에 정의된, views.receive_location과 연결된 경로
            const apiUrl = 'api/receive-location/';

            updateStatus('서버에 주변 관광지 정보 요청 중...', false);

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST', // @require_POST 이므로 POST 방식
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // CSRF 토큰 헤더에 추가
                    },
                    body: JSON.stringify({ // 요청 본문에 위도, 경도 포함
                        latitude: lat,
                        longitude: lon
                    })
                });

                // HTTP 응답 상태 확인
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const message = errorData?.message || `서버 요청 실패 (상태 코드: ${response.status})`;
                    throw new Error(message);
                }

                // 성공 응답 처리
                const result = await response.json();

                // 백엔드 응답 status 확인
                if (result.status === 'success') {
                    updateStatus('주변 관광지 정보를 성공적으로 가져왔습니다. 콘솔을 확인하세요.', false);
                    // --- 중요: 받은 관광지 데이터를 콘솔에 출력 ---
                    console.log('성공! 주변 관광지 데이터:', result.places);
                    // 다음 단계: 여기서 result.places 데이터를 사용하여 화면에 표시할 수 있습니다.
                } else {
                    throw new Error(result.message || '백엔드 처리 중 오류 발생');
                }

            } catch (error) {
                // 네트워크 오류 또는 기타 오류 처리
                console.error('데이터 로딩 실패:', error);
                updateStatus(`오류 발생: ${error.message}`, true);
            }
        }

        // --- 유틸리티 함수 ---

        // 상태 메시지 업데이트 함수
        function updateStatus(message, isError = false) {
            statusMessageDiv.textContent = message;
            if (isError) {
                statusMessageDiv.classList.add('error');
            } else {
                statusMessageDiv.classList.remove('error');
            }
        }

        // 위치 정보 오류 처리 함수
        function handleLocationError(error) {
            let errorMessage = '위치 정보를 가져오는 데 실패했습니다.';
            // (오류 코드별 메시지 처리)
            switch(error.code) {
                case error.PERMISSION_DENIED: errorMessage = '위치 정보 접근 권한이 거부되었습니다.'; break;
                case error.POSITION_UNAVAILABLE: errorMessage = '현재 위치 정보를 사용할 수 없습니다.'; break;
                case error.TIMEOUT: errorMessage = '위치 정보를 가져오는 데 시간이 초과되었습니다.'; break;
                default: errorMessage = `알 수 없는 오류 (코드: ${error.code})`;
            }
            console.error('위치 오류:', error.message);
            updateStatus(errorMessage, true);
        }

    </script>
</body>
</html>